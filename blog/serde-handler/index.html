<!DOCTYPE html>
<html lang="en-UK">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="Description" content="Blogged Thoughts about Rust">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2">

    <title>Quirl</title>
    <link rel="shortcut icon" href="https://domenicquirl.github.io/favicon.ico" />

    
<!-- CSS -->
<link rel="stylesheet" href="../../font-opensans.css" />
<link rel="stylesheet" href="../../font-fira.css" />
<link rel="stylesheet" href="../../main.css" />

<!-- Syntax Highlighting -->
<link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
<link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />

<!-- Atom Feed -->
<link rel="alternate" type="application/atom+xml" title="Atom"
    href="https://domenicquirl.github.io/blog/atom.xml">

</head>

<body>
    <div class="page">
        <div class="page__content">
            <div class="book-content">
                
<h1 class="title" style="padding-top: 30px;">
    Being Generic over Zero-Copy Request Handlers
</h1>
<p class="subtitle"><strong>2023-11-30</strong></p>
<p>Aka &quot;I Just Want a Nice Request API&quot; or a story about why it's sometimes difficult to have your cake and eat it too.</p>
<hr />
<p>We all need APIs.
They're everywhere and what would we do if there <em>wasn't</em> an interface to our favourite library, the ability to separate concerns and, most importantly, a way to <a href="https://cowsay.morecode.org/">get a cow to tell us a joke in the terminal via  <code>curl</code></a>?
And recently, I was working on a crate wrapping a communication protocol that we use at work.
I'd gotten everything set up nicely, implemented our own message flow on top and the only thing missing that I wanted to provide with the library was a nice abstraction for request-response endpoints to handle their requests.</p>
<p>See, while the protocol defines a <code>Message</code> datatype, it's not very nice to work with what basically amounts to a bag of bytes when implementing the API of a particular service.
It is inconvenient and cumbersome to write out the same code for checking a <code>Message</code>'s format at the protocol level, deserializing the <code>Message</code> into something more useful that the service understands, handling it and then serializing the response and constructing a protocol-conformant response in every service that wants to use the crate.
Not only is this repetitive and error prone, it forces the user of the library to think at a lower level conceptually than they would want to: instead of thinking about their service and its API, they have to think about the transport mechanism and message frames.</p>
<p>Hence, I set out to provide a nice interface that would allow a consumer of the library to define their API on a logical level.
Little did I know that what started with this simple, straightforward ambition would become a longer journey through <code>serde</code> and its lifetimes, <code>axum</code> routers, type erasure and being slapped in the face by compiler errors<sup class="footnote-reference"><a href="#compiler-errors">1</a></sup><span id="fn-compiler-errors"></span>
In this post, I'll take a step back at the end of this implementation zig-zag and retrace my steps, trying to show where and why things can become complicated, what the compiler may be trying to tell you, and how you <em>can</em> have your cake and eat it to.</p>
<h2 id="about-this-post"><a class="zola-anchor" href="#about-this-post" aria-label="Anchor link for: about-this-post">ðŸ”—</a>About This Post</h2>
<p>This post is an (or, well, several) attempt(s) at writing a convenient request-response API. 
It discusses some of the intricacies involved in the quest for low overhead request processing, in particular why zero-copy deserialization of requests makes things more difficult. 
To deal with Rust's lack of collections over generic types (like a <code>Vec</code> of handlers that have different types), we will erase not just types but probably some of our brain cells as well as we try to figure out which type can be referred to from where and why they hell the compiler thinks it's ambiguous again?!?</p>
<p>While this post was triggered by my attempt to implement message routing for a particular format, it is not about a particular message format. 
I want the post to focus on the complexity of implementing handlers independently of the protocol in use.
It is also not really an explanation of how <code>axum</code> is able to magically pass complex types to your web handlers. 
We'll briefly come across where this happens in <code>axum</code>, but we'll be more concerned about how <code>axum</code> can <em>accept and manage</em> all these methods with different parameters as routes than how those parameters end up in the correct place at runtime. 
If you do want to read up some more on <code>axum</code>'s &quot;magic handlers&quot;, check out <a href="https://lunatic.solutions/blog/magic-handler-functions-in-rust/">this post</a> by Bernard Kolobara for an explanation and <code>@alexpusch</code>'s <a href="https://github.com/alexpusch/rust-magic-function-params"><code>rust-magic-function-params</code></a> example for a simplified version of the traits involved in making this happen.</p>
<hr />
<h2 id="blog-repository"><a class="zola-anchor" href="#blog-repository" aria-label="Anchor link for: blog-repository">ðŸ”—</a>Blog Repository</h2>
<p>The example code in this article is publicly available at <a href="https://github.com/domenicquirl/blog/tree/master/serde-handler">https://github.com/<wbr>domenicquirl/<wbr>blog/<wbr>tree/<wbr>master/<wbr>serde-<wbr>handler</a>.
The library crate there contains a submodule for each attempt and a specific attempt can be compiled with <code>cargo check --features &lt;attempt&gt;</code>, where <code>&lt;attempt&gt;</code> is given below for each variation.
For attempts where the library code compiles, there will also be an example that either demonstrates the code is working or shows issues that arise when trying to use it.
To run an example, run <code>cargo run --example &lt;attempt&gt; --features &lt;attempt&gt;</code>.<sup class="footnote-reference"><a href="#auto-features">2</a></sup><span id="fn-auto-features"></span></p>
<hr />
<h2 id="the-setup"><a class="zola-anchor" href="#the-setup" aria-label="Anchor link for: the-setup">ðŸ”—</a>The Setup</h2>
<p>To avoid getting side-tracked by the underlying protocol, let's just say we have a few services, some generic <code>Requester</code> type for sending protocol requests to these services from clients, and a complimentary <code>Responder</code> type for receiving and answering requests from a <code>Requester</code> (conveniently, this also means I can cheat and not actually use any protocol for the examples).
Our basic interface thus looks like this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Requester</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Responder</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Requester</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">send_request</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span>, 
        <span class="z-variable z-parameter z-rust">request</span><span class="z-punctuation z-separator z-rust">:</span> Message, 
        <span class="z-variable z-parameter z-rust">to_service</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-type z-rust">str</span>
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">recv_response</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>Message<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Responder</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">next_request</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>Message<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">send_response</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">message</span><span class="z-punctuation z-separator z-rust">:</span> Message</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We can send requests and receive responses in the underlying <code>Message</code> format from the protocol on one side, and receive those requests and send responses on the other.
Right now, both sides of the communication effectively do the same thing - except that the <code>Requester</code> has to specify whom to request from -, but we will add to their functionality over the course of this post.</p>
<p>Next, we want to &quot;automate&quot; the conversions to and from <code>Message</code> to whatever <code>to_service</code> actually expects the request to look like and what it produces as a response.
Let's start by tying together those two types (the request and the response) with a trait:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Api</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> 
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The request body.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The data returned to answer a `Request`.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>For us, <code>Request</code> is always going to be some form of the implementing type.
So, for example, we could have a <code>struct FooRequest</code> representing a request to the <code>foo_service</code>.
If the <code>foo_service</code> returns a <code>String</code> as the reply to a <code>FooRequest</code>, we would represent that as</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Api <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">FooRequest</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> FooRequest<span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This already allows us to write a much nicer interface for our <code>Requester</code>.
For the purpose of this post and the examples, we'll use <code>serde_json</code> to serialize and deserialize our Rust request and response types to and from bytes:<sup class="footnote-reference"><a href="#bounding-the-request-type">3</a></sup><span id="fn-bounding-the-request-type"></span></p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Requester</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">request</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">request</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request, <span class="z-variable z-parameter z-rust">for_service</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>Serialize,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>DeserializeOwned,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> data <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>to_vec_pretty<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> request <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Message<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send_request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request<span class="z-punctuation z-separator z-rust">,</span> for_service</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Failed to send request: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> response <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">recv_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Error receiving response: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>from_slice<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>response<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Deserialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>As a bonus, we can utilize the fact that we are now dealing with <code>FooRequest</code>s instead of <code>Message</code>s, which we know is the request type of service <code>foo_service</code>, to automatically figure out that the request needs to be routed to <code>foo_service</code> in the <code>Requester</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Api</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> 
<mark>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The service whose API is extended with this implementation.
</span></mark><mark>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span></mark><mark>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> `Request`s of the implementing type will be sent to this service.
</span></mark><mark>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">SERVICE</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>
</mark>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The request body.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The data returned to answer a `Request`.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Requester</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">request</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">request</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>Serialize,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>DeserializeOwned,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> data <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>to_vec_pretty<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> request <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Message<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<mark>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Use `A::SERVICE` to route to the correct receipient
</span></mark><mark>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                         vvvvvvvvvv
</span></mark><mark>        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send_request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">SERVICE</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</mark><mark>            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Failed to send request: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</mark>        <span class="z-storage z-type z-rust">let</span> response <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">recv_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Error receiving response: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>from_slice<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>response<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Deserialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Look ma, no <code>for_service</code> anymore!
However, we're missing a counterpart on the <code>Responder</code> side.
We can implement a similar workflow to the <code>Requester</code> by running the same steps in reverse, in a loop so the <code>Responder</code> fetches and responds to one request after the other.
Instead of the name of the service that takes the request (which, on the service's side, is just the <code>Requester</code> itself), our endpoint takes the <em>logical</em> message handler.
That is, you can pass a function that takes an <code>Api::Request</code> and returns an <code>Api::Reply</code> and the <code>Responder</code> will continuously feed it with new requests that it has already decoded and take care of serializing and wrapping the <code>Reply</code> as well:<sup class="footnote-reference"><a href="#return-errors">4</a></sup><span id="fn-return-errors"></span></p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Responder</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Perpetually waits for incoming requests on `self` and 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> handles them with the given `handler`, sending back the 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> computed reply.
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">serve_forever</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        H<span class="z-punctuation z-separator z-rust">:</span> FnMut<span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-section z-group z-end z-rust">)</span> -&gt; <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>DeserializeOwned,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span>Serialize,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-storage z-type z-rust">let</span> request <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next_request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span>Request <span class="z-keyword z-operator z-assignment z-rust">=</span> 
                <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>from_slice<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>request<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Deserialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> reply <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> data <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>to_vec_pretty<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>reply</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> response <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Message<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This code compiles, which you can verify by <code>cargo check</code>ing the code in the repo with the <code>start</code> feature, and this post could simply end here.
However.</p>
<h2 id="the-problem-zero-copy-deserialization"><a class="zola-anchor" href="#the-problem-zero-copy-deserialization" aria-label="Anchor link for: the-problem-zero-copy-deserialization">ðŸ”—</a>The Problem: Zero-Copy Deserialization</h2>
<p>As it is written above, on the service side our <code>Responder</code> API forces the request data to be copied into the logical <code>A::Request</code> type.
When we say <code>let request: A::Request = serde_json::from_slice(x)</code>, <code>serde_json</code> will recursively construct whatever is inside <code>A::Request</code> and the request type itself from the JSON object represented by the bytes in <code>x</code> by copying those bytes into a new, <strong>owned</strong> Rust type.
This can be, for example, a <code>u32</code> or a <code>String</code>, but not a <code>&amp;u32</code> or a <code>&amp;str</code>, since those are references, not owned data.
We can see the requirement that we can deserialize into an owned <code>Request</code> in the <code>where</code> bounds of <code>serve_forever</code>, where we ask for <code>A::Request: serde::DeserializeOwned</code>.</p>
<h3 id="aside-serde-lifetimes"><a class="zola-anchor" href="#aside-serde-lifetimes" aria-label="Anchor link for: aside-serde-lifetimes">ðŸ”—</a>Aside: <code>serde</code> Lifetimes</h3>
<p>Most of the time, we all probably primarily use <code>serde</code> by deriving <code>Serialize</code> and / or <code>Deserialize</code> for our types so they work with whatever other library we want to use that implements or uses a data format (such as <code>serde_json</code> for JSON or a webserver crate that uses <code>serde_json</code> internally to help you build a JSON Web API).
If that is the case for you too, you might not have come across <code>DeserializeOwned</code> before.
But the derive macro for the <code>Deserialize</code> trait actually hides the fact that the trait has a lifetime: the actual definition of <code>Deserialize</code> is <code>trait Deserialize&lt;'de&gt;: Sized</code>.<sup class="footnote-reference"><a href="#serialize">5</a></sup><span id="fn-serialize"></span></p>
<p>The <code>serde</code> documentation contains <a href="https://serde.rs/lifetimes.html">its own section</a> about what this lifetime means and what it is for.
For our purposes, the most important feature that the <code>'de</code> lifetime enables is <em>zero-copy deserialization</em>.
&quot;Zero-copy&quot; refers to the fact that, as opposed to our current <code>serve_forever</code> implementation, a request can be deserialized into a type that holds a reference into the request instead of copying everything over into the struct.</p>
<p>Consider a service which provides an API to convert some text to uppercase.
With our current code, the request type looks like this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">serde::Deserialize</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">UppercaseRequest</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">input</span><span class="z-punctuation z-separator z-type z-rust">:</span> String
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Where <code>input</code> is an owned <code>String</code>.
<code>serde</code>, however, also supports deriving <code>Deserialize</code> for a struct like this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">serde::Deserialize</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">UppercaseRequest</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;input</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">input</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;input</span> <span class="z-storage z-type z-rust">str</span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Where <code>input</code> is a reference to the text stored in the request JSON: </p>
<pre data-lang="json" class="language-json z-code"><code class="language-json" data-lang="json"><span class="z-source z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span> 
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>input<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>Foo<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span> 
    <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span>        ^^^
</span>    <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span>         |
</span>    <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span>         -- input from UppercaseRequest
</span><span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></code></pre>
<p>The <code>serde</code> derive will make <code>UppercaseRequest&lt;'input&gt;</code> (with the lifetime) implement <code>Deserialize&lt;'input&gt;</code>, which means it's possible to deserialize some data that lives at least as long as some lifetime <code>'a</code> into an <code>UppercaseRequest&lt;'a&gt;</code> of the same lifetime (provided that the data is a string, of course).
For structs without a lifetime (like the first <code>UppercaseRequest</code> where <code>input</code> is a <code>String</code>), <code>Deserialize&lt;'de&gt;</code> will be implemented for <em>any</em> lifetime <code>'de</code>, because all data in the struct is owned and you can use the Rust type independently of the input buffer of the request once deserialized.</p>
<p>Coincidentally, this is exactly what our current <code>DeserializeOwned</code> bound requires of the request type: it is equivalent to the bound <code>A::Request: for&lt;'de&gt; Deserialize&lt;'de&gt;</code>, which is the Rust syntax for &quot;no matter the lifetime <code>'de</code> of the input, this type implements <code>Deserialize</code> with that lifetime (which means it can be deserialized from that input)&quot;.
But copying every single request is a lot of work, so could we support zero-copy deserialization in our API as well?</p>
<h3 id="let-s-try-to-be-zero-copy"><a class="zola-anchor" href="#let-s-try-to-be-zero-copy" aria-label="Anchor link for: let-s-try-to-be-zero-copy">ðŸ”—</a>Let's Try to be Zero-Copy!</h3>
<p>We'll need to change the bound on <code>serve_forever</code> away from <code>DeserializeOwned</code> to <code>Deserialize&lt;'de&gt;</code> with a lifetime.
But... what lifetime? Where does it come from?
The request is deserialized <em>inside</em> <code>serve_forever</code> so we can pass it to the handler, so the lifetime of the input buffer and the lifetime of the Rust request object are both some subset of the current function.
That's not something we can really explicitly refer to,<sup class="footnote-reference"><a href="#named-block-lifetimes">6</a></sup><span id="fn-named-block-lifetimes"></span> so maybe this means <code>serve_forever</code> just has to be generic over <code>'de</code> and the compiler will figure out what lifetime that represents?</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Perpetually waits for incoming requests on `self` and 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> handles them with the given `handler`, sending back the 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> computed reply.
</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">serve_forever</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span>, A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
    H<span class="z-punctuation z-separator z-rust">:</span> FnMut<span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-section z-group z-end z-rust">)</span> -&gt; <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply,
    <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Deserialize<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
    <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply<span class="z-punctuation z-separator z-rust">:</span> Serialize,
</span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> request <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next_request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span>Request <span class="z-keyword z-operator z-assignment z-rust">=</span> 
            <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>from_slice<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>request<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Deserialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> reply <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> data <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>to_vec_pretty<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>reply</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> response <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Message<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>If we try to compile this (which you can try with <code>--features zero_copy1</code> in the repo), we get an error:</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0597]: `data` does not live long enough
  --&gt; src\zero_copy1.rs:60:40
   |
51 |     pub fn serve_forever&lt;&#39;de, A: Api, H&gt;(self, mut handler: H) -&gt; Result&lt;()&gt;
   |                          --- lifetime `&#39;de` defined here
...
58 |             let data = self.next_request()?.data();
   |                 ---- binding `data` declared here
59 |             let data = serde_json::from_slice(&amp;data)
   |                 ------------------------------^^^^^-
   |                 |                             |
   |                 |                             borrowed value 
   |                 |                             does not 
   |                 |                             live long enough
   |                 argument requires that `data` is borrowed 
   |                 for `&#39;de`
...
66 |         }
   |         - `data` dropped here while still borrowed
</span></code></pre>
<p>Seems like the compiler is not happy about us leaving the <code>'de</code> lifetime up in the air.
As there is nowhere else that takes a lifetime, we might try to use the <code>for&lt;'de&gt;</code> syntax from above to summon one out of thin air inside the <code>where</code> bound for <code>Deserialize&lt;'de&gt;</code> instead of the function generic parameters, but as we've learned this just means <code>DeserializedOwned</code>, which we had before.
So while it compiles, the <code>zero_copy2</code> example in the repo shows that we can't actually invoke <code>serve_forever</code> with that bound for our borrowing <code>UppercaseRequest</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">error: implementation of `Deserialize` is not general enough
  --&gt; examples\zero_copy2.rs:28:14
   |
28 |             .serve_forever::&lt;UppercaseRequest, _&gt;(|request| 
   |              ^^^^^^^^^^^^^ implementation of `Deserialize` is not 
   |                            general enough
   |
   = note: `UppercaseRequest&lt;&#39;_&gt;` must implement `Deserialize&lt;&#39;0&gt;`, 
           for any lifetime `&#39;0`...
   = note: ...but `UppercaseRequest&lt;&#39;_&gt;` actually implements 
           `Deserialize&lt;&#39;1&gt;`, for some specific lifetime `&#39;1`
</span></code></pre>
<p>Don't be confused by the lifetime names <code>'0</code> and <code>'1</code> that the compiler uses.
The important information is that we &quot;must implement <code>Deserialize</code> for any lifetime&quot; (because we said so by requesting <code>for&lt;'de&gt; Deserialize&lt;'de&gt;</code>, just that the compiler names <code>'de</code> as <code>'0</code> instead), but <code>UppercaseRequest</code> contains a lifetime (the <code>input</code> reference) and so we can only <code>Deserialize</code> for this &quot;specific lifetime&quot; (which the compiler calls <code>'1</code>).</p>
<h3 id="going-higher-order"><a class="zola-anchor" href="#going-higher-order" aria-label="Anchor link for: going-higher-order">ðŸ”—</a>Going Higher-Order</h3>
<p>This doesn't work.
We won't get any further without a way to tie the <code>Deserialize</code> lifetime <code>'de</code> to the (potential) lifetime in our request type, so we need a way to pass <code>'de</code> through to <code>UppercaseRequest</code>.
One way to do this would be to make the <code>Api</code> trait generic over a lifetime as well, like <code>Deserialize</code> is:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now with lifetime!
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>            vvv
</span><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Api</span>&lt;&#39;de&gt; <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The service whose API is extended with this implementation.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> `Request`s of the implementing type will be sent to this 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> service.
</span>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">SERVICE</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>

<mark>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The request body.
</span></mark>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-meta z-generic z-rust">Deserialize<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                                    ^^^
</span>    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>       can now mention the same lifetime
</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The data returned to answer a `Request`.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> DeserializeOwned<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Note that we've also moved the <code>Serialize</code> and <code>Deserialize</code> bounds from the respective functions into the trait definition so both <code>'de</code>s are in the same place.
But, since we have them now, let's use generic associated types (GATs) instead!
With GATs, we can move the lifetime for the requests onto the <code>Request</code> associated type itself: </p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Api</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The service whose API is extended with this implementation.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> `Request`s of the implementing type will be sent to this 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> service.
</span>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">SERVICE</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>

<mark>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The request body.
</span></mark>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-meta z-generic z-rust">Deserialize<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The data returned to answer a `Request`.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> DeserializeOwned<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>With either version, there is now a lifetime associated with <code>Api</code> that is passed on to the <code>Deserialize</code> bound on the <code>Request</code> type.
Therefore, we now have access to <code>'de</code> when implementing <code>Api</code> for our <code>UppercaseRequest</code> and can pass it on to our type:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Api <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">UppercaseRequest</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>&#39;<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
<mark>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">UppercaseRequest<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</mark>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">SERVICE</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-other z-rust">TEXT_SERVICE</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Which, combined with the trait definition, means that we have established a &quot;lifetime chain&quot; <code>UppercaseRequest&lt;'_&gt;::Request&lt;'de&gt; = UppercaseRequest&lt;'de&gt;: Deserialize&lt;'de&gt;</code>.</p>
<p>When updating <code>serve_forever</code>, we have to concern ourselves with the type of the <code>handler</code> parameter:
So far, this has been <code>H: FnMut(A::Request) -&gt; A::Reply</code> - a function from requests to replies.
This is still what we want, but now <code>A::Request</code> is actually <code>A::Request&lt;'de&gt;</code>, so we've got the inverse problem as before: now we <em>can</em> name a lifetime, but that also means we <em>have</em> to pass one and need to figure out which is correct.</p>
<p>The simplest possible solution would be to once again defer to the compiler and write <code>H: FnMut(A::Request&lt;'_&gt;) -&gt; A::Reply</code>.
Surprisingly, this time it actually works!
To the compiler, <code>'_</code> means &quot;any lifetime&quot; (as opposed to &quot;some specific lifetime <code>'1</code>&quot;), so the above is equivalent to <code>H: for&lt;'de&gt; FnMut(A::Request&lt;'de&gt;) -&gt; A::Reply</code>: no matter <code>'de</code>, if I have a request with that lifetime then I can pass it to the handler and it will compute a <code>Reply</code>.
This time, this is what we want and everything works and you can send as many <code>UppercaseRequests</code> as your heart desires by running the <code>zero_copy3</code> example and entering evil lowercase text on the terminal that must be converted to uppercase glory.</p>
<h3 id="giving-our-bound-a-name"><a class="zola-anchor" href="#giving-our-bound-a-name" aria-label="Anchor link for: giving-our-bound-a-name">ðŸ”—</a>Giving Our Bound A Name</h3>
<p>For our single <code>serve_forever</code> function, it's fine to write out the rather convoluted bound for <code>H</code> and be done with it.
If there were multiple functions that accepted such a type, it's probably better to define a name for it in one place so you can refer to just the name wherever you might need it.</p>
<p>We'll define two new traits, <code>HandlerOn&lt;'req&gt;</code> and <code>Handler</code>, that represent handlers that can handle a request with a specific lifetime <code>'req</code> and requests for any lifetime, respectively:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> A function that can handle [`A::Request&lt;&#39;de&gt;`](Api::Request) 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> for `&#39;de == &#39;req`.
</span><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">HandlerOn</span>&lt;&#39;req, A: Api&gt;: 
    FnMut(A::Request&lt;&#39;req&gt;) -&gt; A::Reply <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span>, A<span class="z-punctuation z-separator z-rust">:</span> Api, F<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">HandlerOn<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span>, A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">F</span> 
    </span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span> F<span class="z-punctuation z-separator z-rust">:</span> FnMut<span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span><span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-section z-group z-end z-rust">)</span> -&gt; <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> A function that can handle [`A::Request&lt;&#39;de&gt;`](Api::Request) 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> for any `&#39;de`.
</span><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Handler</span>&lt;A: Api&gt;: for&lt;&#39;req&gt; HandlerOn&lt;&#39;req, A&gt; <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, F<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">for<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-meta z-generic z-rust">HandlerOn<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span>, A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">F</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>The definition of <code>serve_forever</code> now becomes just</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">serve_forever</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>To verify that this indeed still runs as before, run example <code>zero_copy4</code> in the repository.
You can read more on this entire construction in <a href="https://users.rust-lang.org/t/generic-parameter-bound-by-deserialize-de-is-this-pattern-possible-in-rust/82163/3">this URLO thread</a> if you want to.</p>
<h2 id="the-other-problem-many-different-requests"><a class="zola-anchor" href="#the-other-problem-many-different-requests" aria-label="Anchor link for: the-other-problem-many-different-requests">ðŸ”—</a>The Other Problem: Many Different Requests</h2>
<p>We've succeeded in writing an API for both clients and services that allows them to implement an API purely by working with a logical Rust request and response data structure.
So that's it! Time to head home.
Unless, of course, you want your services to serve more than a single kind of requests.</p>
<p>Currently, you can call <code>serve_forever</code> on a <code>Responder</code> and, well, serve one implementation of <code>Api</code>... forever. 
But what if we want our text service to be able to both convert text to uppercase as well as to lowercase? 
And maybe later we'll add an API for trimming whitespace, too!
<code>serve_forever</code> can only handle (with the given <code>handler</code>) one particular <code>A: Api</code>, though, so what do?</p>
<p>For this example, all requests go from text to text, so we could work around the issue by defining an</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">TextRequest</span>&lt;&#39;a&gt; <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    UppercaseRequest<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> <span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
    LowercaseRequest<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> <span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
    TrimRequest<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> <span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>implementing <code>Api</code> for it and providing a handler that takes a <code>TextRequest</code> and returns a <code>String</code>.
But what if we have one API for strings and one for numbers? 
Or, perhaps more realistically, if all our APIs take some data structure specific to this API as their input that we would like to represent as Rust <code>struct</code>s, and also return similarly different data?</p>
<p>Instead of falling back on two big <code>enum Request</code> and <code>enum Response</code>s where we can't even guarantee that the correct <code>Response</code> variant is sent for a given <code>Request</code>, let's try to come up with a library API that supports multiple types of requests.
Perhaps we can look at some other frameworks for inspiration?
Surely, we can't be the first developers to ever want to route different requests to different handlers... wait, isn't that what like every single web framework does?</p>
<p>Let's look at <code>axum</code> as an example. 
On a high level, it provides a <code>Router</code> type that you can use to build up different web endpoints for different URLs and HTTP methods like so (taking from their <a href="https://docs.rs/axum/latest/axum/">documentation</a>):</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> app <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Router<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">route</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>root</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">route</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>/foo<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>get_foo</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">post</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>post_foo</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">route</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>/foo/bar<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>foo_bar</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>where <code>get_foo</code> etc. are <code>async fn</code>s.
The <code>Router::route</code> method takes a <code>MethodRouter</code> as its second argument, which is basically a static <code>HashMap</code> that can hold one handler per HTTP method (<code>GET</code>, <code>POST</code>, etc.).
This makes sense for a web framework, but we'll only consider one handler per route for this post.</p>
<p>To start with, in addition to the <code>SERVICE</code> name we'll also give each <code>Api</code> its own unique name to differentiate the APIs implemented by a service:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Api</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The service whose API is extended with this implementation.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> `Request`s of the implementing type will be sent to this 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> service.
</span>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">SERVICE</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The unique name of the API that identifies the kind of 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> `Request` to the `SERVICE`.
</span>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">NAME</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The request body.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-meta z-generic z-rust">Deserialize<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The data returned to answer a `Request`.
</span>    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span><span class="z-punctuation z-separator z-rust">:</span> Serialize <span class="z-keyword z-operator z-arithmetic z-rust">+</span> DeserializeOwned<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We'll send the name as part of the underlying protocol <code>Message</code>.<sup class="footnote-reference"><a href="#api-name">7</a></sup><span id="fn-api-name"></span>
Next, we want to have our own router type that maps the API names of a service to their correct handlers.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">ApiRouter</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">handlers</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span>, dyn <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We can then provide APIs to get an <code>ApiRouter</code>, add new handlers and run our <code>serve_forever</code> loop, except now we extract the API name from the request and look up the corresponding handler to invoke.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">ApiRouter</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Create a new `Router`.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Unless you add additional routes via [`register_handler`], 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> this will respond with `InvalidRequest` to all requests.
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">Self</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> handlers<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">HashMap<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Add a new handler for API requests of type `A`.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> This will make the router route all requests of type `A` to 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> the given `handler` if the request data can be successfully 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> deserialized into [`A::Request`]. The `handler` may be a 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> function name or a closure.
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">register_handler</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, 
        <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>handlers<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">NAME</span><span class="z-punctuation z-separator z-rust">,</span> handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-variable z-language z-rust">self</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Perpetually waits for incoming requests on `socket` and 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> handles them with the handler registered for their route, 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> sending back the computed reply.
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">serve_on</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">socket</span><span class="z-punctuation z-separator z-rust">:</span> Responder</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-storage z-type z-rust">let</span> Message <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> api_name<span class="z-punctuation z-separator z-rust">,</span> data </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> socket<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next_request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-storage z-type z-rust">let</span> handler <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span>
                <span class="z-punctuation z-accessor z-dot z-rust">.</span>handlers
                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>api_name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">ok_or_else</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                    <span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>No handler for &#39;<span class="z-constant z-other z-placeholder z-rust">{api_name}</span>&#39;<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> reply <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handler<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> response <span class="z-keyword z-operator z-assignment z-rust">=</span> Message <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                api_name<span class="z-punctuation z-separator z-rust">,</span>
                data<span class="z-punctuation z-separator z-rust">:</span> reply<span class="z-punctuation z-separator z-rust">,</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            socket<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Except. 
This doesn't compile.
We're storing <code>dyn Handler</code>s in the router so we don't have to differentiate between the different types of different handler functions, but <code>Handler</code> is still generic over <code>A</code>, so the compiler (rightfully) complains:</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0412]: cannot find type `A` in this scope
  --&gt; src\multiple_handlers1.rs:27:49
   |
27 |     handlers: HashMap&lt;&amp;&#39;static str, dyn Handler&lt;A&gt;&gt;,
   |                                                 ^ not found in 
   |                                                   this scope
   |
help: you might be missing a type parameter
   |
26 | pub struct ApiRouter&lt;A&gt; {
   |                     +++
</span></code></pre>
<p>It tries to help us by suggesting we make the router generic as well, but we don't want that:
then a service could only have an <code>ApiRouter&lt;SomeRequest&gt;</code> for a fixed request type <code>SomeRequest</code> - exactly what we're trying to fix right now!</p>
<p>How can we get rid of <code>Handler</code>'s generic parameter... maybe we can move the <code>A</code> <em>inside</em> the trait, as an associated type?<sup class="footnote-reference"><a href="#explicit-trait">8</a></sup><span id="fn-explicit-trait"></span>
That would look like this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> A function that can handle [`A::Request&lt;&#39;de&gt;`](Api::Request) 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> for `&#39;de == &#39;req`.
</span><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">HandlerOn</span>&lt;&#39;req&gt;: 
    FnMut(Self::Api::Request&lt;&#39;req&gt;) -&gt; Self::Api::Reply
<span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Api</span><span class="z-punctuation z-separator z-rust">:</span> Api<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span>, A<span class="z-punctuation z-separator z-rust">:</span> Api, F<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">HandlerOn<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">F</span> 
    </span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span> F<span class="z-punctuation z-separator z-rust">:</span> FnMut<span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span><span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-section z-group z-end z-rust">)</span> -&gt; <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">A</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Reply 
</span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Api</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> A<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> A function that can handle [`A::Request&lt;&#39;de&gt;`](Api::Request) 
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> for any `&#39;de`.
</span><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Handler</span>: for&lt;&#39;req&gt; HandlerOn&lt;&#39;req&gt; <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>F<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">for<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-meta z-generic z-rust">HandlerOn<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;req</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> Handler <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">F</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We're saying we want the handler to be a function that takes request of the <code>Api</code> associated type, which is the <code>A: Api</code> in the first <code>impl</code>.
The compiler isn't very happy (feature <code>multiple_handlers3</code>):</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0223]: ambiguous associated type
  --&gt; src\multiple_handlers2.rs:77:34
   |
77 | pub trait HandlerOn&lt;&#39;req&gt;: FnMut(Self::Api::Request&lt;&#39;req&gt;) 
   |     -&gt; Self::Api::Reply {
   |                                  ^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: if there were a trait named `Example` with associated type 
      `Request` implemented for `&lt;Self as HandlerOn&lt;&#39;req&gt;&gt;::Api`, 
      you could use the fully-qualified path
   |
77 | pub trait HandlerOn&lt;&#39;req&gt;: FnMut(&lt;&lt;Self as HandlerOn&lt;&#39;req&gt;&gt;::Api as Example&gt;::Request) -&gt; Self::Api::Reply {
   |                 
</span></code></pre>
<p>Because both <code>Self</code> and <code>Self::Api</code> may implement multiple traits, and any (or all) of these traits could have associated types named <code>Api</code> or <code>Request</code>, the compiler wants us to be specific and say that we mean the <code>Api</code> associated type from <code>HandlerOn</code> and the <code>Request</code> associated type from <code>Api</code> (which it doesn't know, so it gives us an arbitrary <code>Example</code> trait).
Fine, let's write what it says even though it is positively hideous (<code>multiple_handlers2</code>):</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">HandlerOn</span>&lt;&#39;req&gt;:
    FnMut(&lt;Self::Api as Api&gt;::Request&lt;&#39;req&gt;) -&gt; &lt;Self::Api as Api&gt;::Reply
<span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Api</span><span class="z-punctuation z-separator z-rust">:</span> Api<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>That doesn't help, for multiple reasons.
First of all, it is <em>also</em> ambiguous, just in a different way.
Imagine we have the following two <code>Api</code> implementations:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Api1</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Api2</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Api <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Api1</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Api <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Api2</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Request</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;de</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Reply</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Should this implement `Handler&lt;Api = Api1&gt;` 
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> or `Handler&lt;Api = Api2&gt;`?
</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">handler</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">request</span><span class="z-punctuation z-separator z-rust">:</span> String</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> String</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ... <span class="z-punctuation z-definition z-comment z-rust">*/</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Here, <code>handler</code> fits the description of <code>FnMut(A::Request) -&gt; A::Reply</code> for both <code>Api1</code> and <code>Api2</code>, as their <code>Request</code> and <code>Reply</code> types are the same.
But if we change <code>Handler</code> and <code>HandlerOn</code> to use an associated type, we are forced to choose one single value for the implementation of <code>HandlerOn</code> for the <code>fn handler</code>.
We don't, which the compiler reports as</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0207]: the type parameter `A` is not constrained by the impl trait, 
              self type, or predicates
  --&gt; src\multiple_handlers2.rs:82:12
   |
82 | impl&lt;&#39;req, A: Api, F&gt; HandlerOn&lt;&#39;req&gt; for F 
   |            ^ unconstrained type parameter
</span></code></pre>
<p>We <em>do</em> mention <code>A</code> in the bounds of the implementation (<code>where F: FnMut(A::Request&lt;'req&gt;) -&gt; A::Reply</code>), but - as we've shown above - that's not enough to be able to uniquely infer what type <code>A</code> actually represents. 
If you <code>rustc --explain E0207</code> the error, the compiler will tell you the exact rules for what counts as &quot;constraining&quot; a generic parameter:</p>
<blockquote>
Any type or const parameter of an `impl` must meet at least one of the
following criteria:
<ul>
<li>it appears in the <em>implementing type</em> of the impl, e.g. <code>impl&lt;T&gt; Foo&lt;T&gt;</code></li>
<li>for a trait impl, it appears in the <em>implemented trait</em>, e.g.
<code>impl&lt;T&gt; SomeTrait&lt;T&gt; for Foo</code></li>
<li>it is bound as an associated type, e.g. <code>impl&lt;T, U&gt; SomeTrait for T where T: AnotherTrait&lt;AssocType=U&gt;</code></li>
</ul>
<p>Any unconstrained lifetime parameter of an <code>impl</code> is not supported if the
lifetime parameter is used by an associated type.</p>
</blockquote>
<p>So while we <em>mention</em> <code>A</code> in a <code>where</code> bound, we don't constrain anything to <code>A</code> itself, only to its <code>Request</code> and <code>Reply</code> types.</p>
<p>There's another problem as well: because we need these types to write the <code>where</code> bound, we need to go through the implementing type <code>Self</code> to get them.
We want a function that takes the <code>Request</code> type for the API it is a handler for (otherwise it wouldn't make sense), which is <code>Self::Api::Request</code> (same for <code>Reply</code>).
However, this makes the <code>Handler</code> and <code>HandlerOn</code> traits no longer object safe, which means we cannot have a <code>dyn Handler</code>, which we wanted to store in our router (<code>multiple_handlers4</code>):</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0038]: the trait `Handler` cannot be made into an object
  --&gt; src\multiple_handlers4.rs:27:41
   |
27 |     handlers: HashMap&lt;&amp;&#39;static str, Box&lt;dyn Handler&gt;&gt;,
   |                                         ^^^^^^^^^^^ 
   |              `Handler` cannot be made into an object
   |
note: for a trait to be &quot;object safe&quot; it needs to allow building a 
      vtable to allow the call to be resolvable dynamically; for more 
      information visit &lt;https://doc.rust-lang.org/reference/items/traits.html#object-safety&gt;
  --&gt; src\multiple_handlers4.rs:78:5
   |
78 | /     FnMut(
79 | |     &lt;&lt;Self as HandlerOn&lt;&#39;req&gt;&gt;::Api as Api&gt;::Request&lt;&#39;req&gt;,
80 | | ) -&gt; &lt;&lt;Self as HandlerOn&lt;&#39;req&gt;&gt;::Api as Api&gt;::Reply
   | |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   | |______|____________________________________________|
   |        |...because it uses `Self` as a type parameter
   |        |
   |        ...because it uses `Self` as a type parameter
...
89 |   pub trait Handler: for&lt;&#39;req&gt; HandlerOn&lt;&#39;req&gt; {}
   |             ------- this trait cannot be made into an object...
</span></code></pre>
<p>Even if we could somehow magic the trait to still support having a <code>dyn Handler</code>, it wouldn't help because...</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0191]: the value of the associated type `Api` (from trait `HandlerOn`) 
              must be specified
  --&gt; src\multiple_handlers3.rs:27:45
   |
27 |     handlers: HashMap&lt;&amp;&#39;static str, Box&lt;dyn Handler&gt;&gt;,
   |                                             ^^^^^^^ 
   | help: specify the associated type: `Handler&lt;Api = Type&gt;`
...
78 |     type Api: Api;
   |     ------------- `Api` defined here
</span></code></pre>
<p>That's right! 
Associated types don't even solve our problem in the first place, because even when there is only one <code>Api</code> per <code>Handler</code> Rust requires us to name both.
It won't be enough to move the <code>Api</code> generic to somewhere else, we'll need to <em>erase</em> it completely.</p>
<h3 id="calling-upon-the-dark-arts"><a class="zola-anchor" href="#calling-upon-the-dark-arts" aria-label="Anchor link for: calling-upon-the-dark-arts">ðŸ”—</a>Calling Upon The Dark Arts</h3>
<p>The chances to figure this out on our own, on the fly, are fairly low.
Let's instead turn back to our original inspiration for building the router, the <code>axum</code> web framework.
They're doing it, so they've got to know a way to achieve what we want.</p>
<p>The relationship between <code>axum</code>'s diverse set of routing and handler types is quite complex, and reading the codebase is additionally complicated by its deep integration with the <code>tower</code> service framework.
Due to the latter, conversions often involve an extra step to go through some type that implements a <code>tower</code> trait and you need to close the loop through the <code>tower</code> implementation back into <code>axum</code> code.
If you think a class diagram will help you to follow along, you can find one for at least the <code>axum</code> side of things in <a href="https://users.rust-lang.org/t/common-data-type-for-functions-with-different-parameters-e-g-axum-route-handlers/90207/6">this reply on URLO</a>.</p>
<p>When you call <code>.route</code> on an <code>axum::Router</code>, the first thing that happens is actually that you will be delegated to <code>PathRouter</code>.
This is because <code>axum</code> routers additionally support several variations of fallback routes, so <code>PathRouter</code> is what implements the &quot;regular&quot; routing based on the URL paths (or API names, for us).</p>
<p>The <code>PathRouter</code> doesn't do anything special when you add a new route, it just figures out whether it already knows that route and either updates or inserts an <code>Endpoint</code> for the new route.
Let's look at the <code>MethodRouter</code> that is added instead, since it seems to be the actual request handler and thus correspond most to our <code>Handler</code> trait.</p>
<p>When we call <code>axum::method_routing::get(our_handler)</code>, we end up in a macro that calls an <code>axum</code> function called <a href="https://docs.rs/axum/latest/axum/routing/method_routing/fn.on.html"><code>on</code></a>.
This constructs a new <code>MethodRouter</code> and delegates to <em>it's</em> <a href="https://docs.rs/axum/latest/axum/routing/method_routing/struct.MethodRouter.html#method.on"><code>on</code> method</a> which then delegates further to the internal <code>fn on_endpoint</code>.
But before that, a transformation happens: the actual <code>our_handler</code> function passed to <code>get</code> is converted into a type whose name includes &quot;boxed&quot; <em>twice</em>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">on_endpoint</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
    filter<span class="z-punctuation z-separator z-rust">,</span>
    <span class="z-meta z-path z-rust">MethodEndpoint<span class="z-punctuation z-accessor z-rust">::</span></span>BoxedHandler<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> our `our_handler` function vvvvvv
</span>        <span class="z-meta z-path z-rust">BoxedIntoRoute<span class="z-punctuation z-accessor z-rust">::</span></span>from_handler<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre>
<p><code>on_endpoint</code> itself then just stores the converted handler inside the <code>MethodRouter</code>.</p>
<p>What exactly are those &quot;boxed&quot; types? 
Well, <code>axum</code> has <a href="https://docs.rs/axum/0.6.20/src/axum/boxed.rs.html">an entire module</a> of them and the constructor that is used here, <code>BoxedIntoRoute::from_handler</code>, as a very interesting signature:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">BoxedIntoRoute</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>S, B, E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"></span><span class="z-meta z-struct z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
    <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>dyn <span class="z-meta z-generic z-rust">ErasedIntoRoute<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>S, B, E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>S, B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">BoxedIntoRoute</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>S, B, Infallible<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
    S<span class="z-punctuation z-separator z-rust">:</span> Clone + Send + Sync + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    B<span class="z-punctuation z-separator z-rust">:</span> Send + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
</span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">from_handler</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>H, T<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>T, S, B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
        T<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
        B<span class="z-punctuation z-separator z-rust">:</span> HttpBody,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">Self</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>MakeErasedHandler <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            handler<span class="z-punctuation z-separator z-rust">,</span>
            into_route<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-parameter z-rust">state</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-meta z-path z-rust">Route<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Handler<span class="z-punctuation z-accessor z-rust">::</span></span>with_state<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handler<span class="z-punctuation z-separator z-rust">,</span> state</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>There's a lot of generic parameters going on, but what's interesting for us is that, somehow, this function takes a <code>Handler</code> of type <code>H</code> (<code>Handler</code> in <code>axum</code> is what is implemented for <code>async</code> functions that can handle web requests like <code>our_handler</code>, so it's what <em>actually</em> corresponds to our own <code>Handler</code>) and returns a <code>BoxedIntoRoute</code> where <code>H</code> does not appear at all!
And, again somehow, the <code>trait ErasedIntoRoute</code> (which also doesn't mention <code>H</code>) has a <code>fn into_route</code> that returns a <code>Route&lt;B, E&gt;</code> which <em>also</em> doesn't mention <code>H</code> but must end up calling the correct handler.</p>
<p>The technique that is used here is quite clever:
The <em>actual</em> type, <code>MakeErasedHandler</code>, <em>is</em> generic over <code>H</code>.
In fact, the handler is stored right there inside the struct! 
The definition of <code>MakeErasedHandler</code> is</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MakeErasedHandler</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>H, S, B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-modifier z-rust">pub</span><span class="z-punctuation z-definition z-modifier-scope z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">crate</span><span class="z-punctuation z-definition z-modifier-scope z-end z-rust">)</span> <span class="z-variable z-other z-member z-rust">handler</span><span class="z-punctuation z-separator z-type z-rust">:</span> H,
    <span class="z-storage z-modifier z-rust">pub</span><span class="z-punctuation z-definition z-modifier-scope z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">crate</span><span class="z-punctuation z-definition z-modifier-scope z-end z-rust">)</span> <span class="z-variable z-other z-member z-rust">into_route</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-function z-rust">fn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust">H, S<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust">Route<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>However, by also storing <em>the implementation</em> of <code>into_route</code> as a function inside the struct, by pre-constructing this implementation in <code>from_handler</code> above, when the <code>dyn ErasedIntoRoute</code> is used later the code doesn't need to know about the type of <code>H</code> anymore.</p>
<p>We still need to find out where and how the call to the handler actually happens, though, so let's keep looking.
When we check the implementation of <code>Route::new</code>, we are greeted by another &quot;boxed&quot; type:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">Route</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B = Body, E = Infallible<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"></span><span class="z-meta z-struct z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
    <span class="z-meta z-generic z-rust">BoxCloneService<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>, Response, E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B, E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Route</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B, E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">svc</span><span class="z-punctuation z-separator z-rust">:</span> T</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        T<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Service<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>, Error = E<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> + Clone + Send + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">T</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Response<span class="z-punctuation z-separator z-rust">:</span> IntoResponse + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
        <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">T</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Future<span class="z-punctuation z-separator z-rust">:</span> Send + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">Self</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">BoxCloneService<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
            svc<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">IntoResponse<span class="z-punctuation z-accessor z-rust">::</span></span>into_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
        </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This time, <code>BoxCloneService</code> comes not from <code>axum</code> but from <code>tower</code>, but they're using the same trick (just with one more layer of indirection):
the service is turned into a trait object so the <code>T</code> type disappears, and while they're at it <code>T::Future</code> is turned into a type-erased <a href="https://docs.rs/futures-util/0.3.29/futures_util/future/type.BoxFuture.html"><code>futures_util::future::BoxFuture</code></a> as well, which is just a new name for <code>Box&lt;dyn Future&gt;</code>.</p>
<h3 id="back-to-our-own-problems-handlers"><a class="zola-anchor" href="#back-to-our-own-problems-handlers" aria-label="Anchor link for: back-to-our-own-problems-handlers">ðŸ”—</a>Back to Our Own <del>Problems</del> Handlers</h3>
<p>What we have learned (hopefully maybe) from all this type chasing is that we can erase generic type parameters by turning things into trait objects.
The thing is, we were already trying to do that, and failing!
I'll spare you further increasingly desperate code snippets and their corresponding compiler errors, but believe me that it's simply not enough to turn our concrete <code>Handler</code> into a <code>dyn Handler</code>.
Not as long as our handlers want to refer to a specific <code>Request</code> and <code>Reply</code> type.</p>
<p>We've missed the piece of code in <code>axum</code> that turns an <code>async</code> function with specific argument and return types (Rust types!) into a more handler for HTTP requests that returns HTTP responses.</p>
<p>That's because it isn't in any of the code files we've looked at so far.
It also doesn't appear in the class diagram that I linked above (or, well, only indirectly).
But it <em>is</em> how <code>axum</code> defines the interface for their handlers:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-trait z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-trait z-rust">trait</span> <span class="z-entity z-name z-trait z-rust">Handler</span>&lt;T, S, B = Body&gt;: Clone + Send + Sized + &#39;static <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Future</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>Output = Response<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-support z-type z-rust">Send</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Required method
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">call</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">req</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>, <span class="z-variable z-parameter z-rust">state</span><span class="z-punctuation z-separator z-rust">:</span> S</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Future</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Cut: some provided methods
</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>The <code>req: Request&lt;B&gt;</code> here comes straight from the <code>http</code> crate, and the <code>Response</code> that is the <code>Output</code> of the returned <code>Future</code> is from <code>http</code> as well, <code>axum</code> just supplies a default for their type parameters.</p>
<p>If we look at <a href="https://docs.rs/axum/0.6.20/src/axum/handler/mod.rs.html#217">how <code>axum</code> implements <code>Handler</code> for basically any <code>async</code> function</a> (be warned, it's a macro), we'll see something that by now should seem familiar:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> bunch of parameters <span class="z-punctuation z-definition z-comment z-rust">*/</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> the same, really <span class="z-punctuation z-definition z-comment z-rust">*/</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">F</span>
</span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `F` is a function
</span>    F<span class="z-punctuation z-separator z-rust">:</span> FnOnce<span class="z-punctuation z-section z-group z-begin z-rust">(</span>/* generics */<span class="z-punctuation z-section z-group z-end z-rust">)</span> -&gt; Fut + Clone + Send + <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> that returns a future
</span>    Fut<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>Output = Res<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> + Send,
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> whose result can be turned into an HTTP response
</span>    Res<span class="z-punctuation z-separator z-rust">:</span> IntoResponse,
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> and whose inputs can be extracted from a request
</span>    <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> generics <span class="z-punctuation z-definition z-comment z-rust">*/</span></span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">FromRequest<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>S, B, M<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> + Send,
</span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Future</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">Pin<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>dyn <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>Output = Response<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-rust">+</span> <span class="z-support z-type z-rust">Send</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">call</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">req</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Request<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>B<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>, <span class="z-variable z-parameter z-rust">state</span><span class="z-punctuation z-separator z-rust">:</span> S</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Future</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>pin<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>async <span class="z-storage z-modifier z-rust">move</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> extract arguments to `F` from `req`
</span>            <span class="z-storage z-type z-rust">let</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">mut</span> parts<span class="z-punctuation z-separator z-rust">,</span> body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> req<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_parts</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> state <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>state<span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
                <span class="z-storage z-type z-rust">let</span> <span class="z-variable z-other z-rust">$ty</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> 
                    <span class="z-keyword z-control z-rust">match</span> <span class="z-variable z-other z-rust">$ty</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from_request_parts<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> parts<span class="z-punctuation z-separator z-rust">,</span> state</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                        <span class="z-punctuation z-accessor z-dot z-rust">.</span>await 
                    <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=&gt;</span> value<span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>rejection</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=&gt;</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-keyword z-control z-rust">return</span> rejection<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>

            <span class="z-storage z-type z-rust">let</span> req <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Request<span class="z-punctuation z-accessor z-rust">::</span></span>from_parts<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>parts<span class="z-punctuation z-separator z-rust">,</span> body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-storage z-type z-rust">let</span> <span class="z-variable z-other z-rust">$last</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-control z-rust">match</span> <span class="z-variable z-other z-rust">$last</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from_request<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>req<span class="z-punctuation z-separator z-rust">,</span> state</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=&gt;</span> value<span class="z-punctuation z-separator z-rust">,</span>
                <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>rejection</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=&gt;</span> <span class="z-keyword z-control z-rust">return</span> rejection<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> call `F` is with the extracted arguments
</span>            <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">self</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-other z-rust">$ty</span><span class="z-punctuation z-separator z-rust">,</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-variable z-other z-rust">$last</span><span class="z-punctuation z-separator z-rust">,</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> convert the result back into a `Response`
</span>            res<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_response</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Calling the handler with an HTTP request constructs a <code>Future</code> - a separate function - which</p>
<ul>
<li>extracts any arguments to the handler from the request,</li>
<li>calls the handler with those arguments, and</li>
<li>converts its response into an HTTP response.</li>
</ul>
<p>And the type of <code>Future</code> is <code>Pin&lt;Box&lt;dyn Future&lt;Output = Response&gt;&gt;</code> - a <code>Future</code> trait object that hides the type of <code>F</code> because it is wrapped in &quot;some future&quot; and returns a generic HTTP response.</p>
<p><em>The</em> important insight here is <em>when</em> we need to do all of the type erasure and wrapping into closures / <code>async</code> functions: 
it needs to happen when the original type / function is still accessible to us.</p>
<p>It's not really about the trait object so much and more about the fact that, in the same place, we're able to</p>
<ul>
<li>take a generic request</li>
<li>convert it to Rust types because we have access to the argument types of the function and their <code>FromRequest</code> implementations</li>
<li>call the actual function</li>
<li>convert the result back because we have access to the return type and its <code>IntoResponse</code> implementation</li>
</ul>
<p>I want to emphasize that, of these, only the function itself is a <em>value</em>.
The reason we can convert the arguments and the result is not because they are already in scope - they are not, they are extracted from the request and computed by the handler.
Instead, what makes things work is that, <strong>at compile time</strong>, we can refer to the argument and result <em>types</em> and tell the compiler that &quot;we want to call <em>their</em> conversion methods please&quot;.</p>
<h3 id="so-let-s-do-it"><a class="zola-anchor" href="#so-let-s-do-it" aria-label="Anchor link for: so-let-s-do-it">ðŸ”—</a>So Let's Do It!</h3>
<p>What does this mean for us?
Well, here's all we need to get us a type-erased handler that still converts everything correctly:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">BoxedRequestHandler</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>dyn <span class="z-support z-type z-rust">FnMut</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span>[<span class="z-storage z-type z-rust">u8</span>]<span class="z-punctuation z-section z-group z-end z-rust">)</span> <span class="z-punctuation z-separator z-generic z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">BoxedHandler</span></span><span class="z-meta z-struct z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>BoxedRequestHandler</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">BoxedHandler</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">from_handler</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> handler <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">move</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span>request_data<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-storage z-type z-rust">let</span> request<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span>Request<span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>&#39;<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> 
                <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>from_slice<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request_data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Deserialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> reply <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>request</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> reply <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">serde_json<span class="z-punctuation z-accessor z-rust">::</span></span>to_vec_pretty<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>reply</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serialize error: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reply</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">Self</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Let's break it down again:
<code>BoxedHandler</code> is a handler not for any specific API type(s), but that converts from bytes to bytes (<code>&amp;[u8]</code> in, <code>Vec&lt;u8&gt;</code> out).
We can construct a <code>BoxedHandler</code> for a concrete <code>A: Api</code> because <code>from_handler</code> knows what <code>A</code> is (since it's a generic parameter).
This means we can refer to <em>the type</em> <code>A</code> from within the constructed closure, which means we can convert to and from the correct request and response types.</p>
<p>In a way, we are taking the knowledge about <code>A</code> with us into the future, from when the <code>BoxedHander</code> is built to when we call the contained function, by having the compiler insert a call to the correct trait implementation when it generates the closure.
Yeah.
Let that sink in.</p>
<p>The only other change we need to make is to <code>register_handler</code>, which needs to turn the given function into a <code>BoxedHandler</code> to store it:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">ApiRouter</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">handlers</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span>, BoxedHandler<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">ApiRouter</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Add a new handler for API requests of type `A`.
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> This will make the router route all requests of type `A` to 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> the given `handler` if the request data can be successfully 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> deserialized into [`A::Request`](Api::Request). The `handler` 
</span>    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> may be a function name or a closure.
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">register_handler</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-separator z-rust">:</span> Api, H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Handler<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>A<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, 
        <span class="z-variable z-parameter z-rust">handler</span><span class="z-punctuation z-separator z-rust">:</span> H
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">Self</span>
    </span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
        H<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span>,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>handlers
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">A<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">NAME</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">BoxedHandler<span class="z-punctuation z-accessor z-rust">::</span></span>from_handler<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handler</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-variable z-language z-rust">self</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>You can try our router out by running the <code>working</code> example in the repository, where you will finally be able to have your one-liners converted to uppercase and lowercase and be trimmed by the same service.
Time to rest and enjoy our success.</p>
<h2 id="bonus-more-errors-i-ve-been-avoiding"><a class="zola-anchor" href="#bonus-more-errors-i-ve-been-avoiding" aria-label="Anchor link for: bonus-more-errors-i-ve-been-avoiding">ðŸ”—</a>Bonus: More Errors I've Been Avoiding</h2>
<p>If you've made it this far, congratulations!
I hope your brain is still mostly intact and your head hasn't exploded.
There's one more version of the implementation in the repository, though, that demonstrates an error that one might run into if not copying and pasting the exact code from the this post / the working solution: <code>missing_closure_type</code>.</p>
<p>In the above code for constructing a <code>BoxedHandler</code>, I wrote out the type of the <code>request_data</code> parameter of the generic handler:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> handler <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">move</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span>request_data<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span></span></code></pre>
<p>This may seem arbitrary or like it's only done to be more explicit in the example, but it's not.
Here's what happens if you leave it to the compiler to infer the type of <code>request_data</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">error[E0308]: mismatched types
   --&gt; src\missing_closure_type.rs:119:14
    |
119 |         Self(Box::new(handler))
    |              ^^^^^^^^^^^^^^^^^ 
    |              one type is more general than the other
    |
    = note: expected trait `for&lt;&#39;a&gt; FnMut&lt;(&amp;&#39;a [u8],)&gt;`
               found trait `FnMut&lt;(&amp;[u8],)&gt;`
note: this closure does not fulfill the lifetime requirements
   --&gt; src\missing_closure_type.rs:111:23
    |
111 |         let handler = move |request_data| -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
help: consider specifying the type of the closure parameters
    |
111 |         let handler = |request_data: &amp;_| {
    |                       ~~~~~~~~~~~~~~~~~~

error: implementation of `FnOnce` is not general enough
   --&gt; src\missing_closure_type.rs:119:14
    |
119 |         Self(Box::new(handler))
    |              ^^^^^^^^^^^^^^^^^ implementation of `FnOnce` 
    |                                is not general enough
    |
    = note: closure with signature 
            `fn(&amp;&#39;2 [u8]) -&gt; std::result::Result&lt;Vec&lt;u8&gt;, std::string::String&gt;` 
            must implement `FnOnce&lt;(&amp;&#39;1 [u8],)&gt;`, for any lifetime `&#39;1`...
    = note: ...but it actually implements `FnOnce&lt;(&amp;&#39;2 [u8],)&gt;`, 
            for some specific lifetime `&#39;2`
</span></code></pre>
<p>If you use an IDE with <code>rust-analyzer</code>, it will infer <code>request_data</code> to be of type <code>&amp;[u8]</code>.
Even the compiler infers <code>handler</code> to be of a type that implements <code>FnMut&lt;(&amp;[u8],)&gt;</code>.
But, apparently, the compiler also picks some concrete lifetime for the reference instead of &quot;any lifetime&quot;, i.e., <code>for&lt;'a&gt; FnMut&lt;(&amp;'a [u8],)&gt;</code>.</p>
<p>We've seen this error already when we were working with <code>Deserialize&lt;'de&gt;</code>, we know what it means.
But I neither know why the compiler infers one over the other here, nor how I would explicitly specify that I want one or the other (aside from having a nameable lifetime in scope that the reference should use).
If you know more, please get in touch.</p>
<hr />
<div class="footnote-definition" id="compiler-errors"><sup class="footnote-definition-label">1</sup>
<p>While I think some of the errors were some of the more cryptic ones I have seen so far, they still state fairly clearly what the problem is - if you know what they are talking about at all. Lifetimes and higher-ranked bounds are a tricky area to begin with, so I don't particularly fault the compiler and refrained from attributing them with things like &quot;confusing&quot;, or &quot;weird&quot;, or the above &quot;cryptic&quot; and I am not trying to summon Esteban.<a href="#fn-compiler-errors" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="auto-features"><sup class="footnote-definition-label">2</sup>
<p>It's unfortunate that the feature has to be specified even though we can (and I have) set the <code>required-features</code> for an example in <code>Cargo.toml</code>. You'll currently get an error from cargo that tells you to add the correct <code>--feature</code> flag if you try running the example without it, so clearly <code>cargo</code> knows what's up. But this is one of these issues that are a lot more difficult to actually change than it seems on the surface - if you're curious, you can check out the <code>cargo</code> issue for this at <a href="https://github.com/rust-lang/cargo/issues/4663"><code>cargo#4663</code></a>. <a href="#fn-auto-features" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="bounding-the-request-type"><sup class="footnote-definition-label">3</sup>
<p>In the example code, I've used a slightly different signature for <code>request</code>: there, it is written as <code>fn request&lt;A: Api&lt;Request = A&gt;&gt;</code> and takes the request as an <code>A</code> instead of an <code>A::Request</code>. Constraining the implementation of <code>Api</code> to be implemented on the request type itself is less flexible, but allows calling <code>request</code> without specifying <code>A</code> with a turbofish (as <code>requester.request::&lt;FooRequest&gt;(req)</code>) because the compiler is able to infer the generic parameter from the argument type. But it's also a bit ugly and requires bounding <code>Api</code> itself by <code>Serialize</code>, so I'm leaving it as a footnote. <a href="#fn-bounding-the-request-type" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="return-errors"><sup class="footnote-definition-label">4</sup>
<p>I'm presupposing that the logical handler is &quot;infallible&quot;, which just means that if there <em>is</em> an error with or while processing the request, this will be communicated to the requester via the <code>Reply</code> as opposed to having the handler fail (by allowing it to return a <code>Result&lt;Reply, E&gt;</code> with some error). Since the protocol format and also (de-)serialization are handled by our API, any remaining error can only be a logical one. When implementing <code>Api</code>, this can be represented by making <code>Reply</code> be a <code>Result&lt;T&gt;</code>, using an <code>enum FooReply</code> as the <code>Reply</code> type that contains an <code>InvalidRequest</code> variant, or similar. <a href="#fn-return-errors" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="serialize"><sup class="footnote-definition-label">5</sup>
<p>This is not the case for <code>Serialize</code>. When you serialize a type to some format, you probably intend to send the resulting bytes somewhere else, e.g. over the network to make a web request. It would be of little use to be able to borrow from the Rust type from within the serialized bytes, and besides you cannot serialize to a single byte buffer or string of which only a subsection is a reference to the original type and the rest is owned bytes, so <code>serde</code> doesn't support it. <a href="#fn-serialize" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="named-block-lifetimes"><sup class="footnote-definition-label">6</sup>
<p>No, <a href="https://github.com/rust-lang/rfcs/pull/2046"><code>label-break-value</code></a> doesn't count here. <a href="#fn-named-block-lifetimes" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="api-name"><sup class="footnote-definition-label">7</sup>
<p>If the underlying protocol supports it, the API (as well as the service) could also be identified by a numeric ID or some other, more compact identifier. I'll stick to string names here, though, since it makes the examples more readable. <a href="#fn-api-name" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>
<div class="footnote-definition" id="explicit-trait"><sup class="footnote-definition-label">8</sup>
<p>Note that there is no way to do this with the original bound of <code>H: for&lt;'de&gt; FnMut(A::Request&lt;'de&gt;) -&gt; A::Reply</code>. There is simply no place in the syntax where we could even <em>state</em> an associated type. This might already give you an idea of how well this is going to turn out... <a href="#fn-explicit-trait" class="footnote-backref" role="doc-backlink">â†©ï¸Ž</a></p>
</div>


            </div>
        </div>
    </div>

    <footer>
        <div class="footer-table">
            <div class="footer-socials">
                <ul class="socials-list">
                    <li>
                        <a href="https://github.com/domenicquirl/blog">
                            <span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px">
                                    <path fill="#828282"
                                        d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z" />
                                </svg></span>
                            <span>Blog Repository</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/domenicquirl">
                            <span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px">
                                    <path fill="#828282"
                                        d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z" />
                                </svg></span>
                            <span>GitHub</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-name">
                <p>Domenic Quirl</p>
            </div>
            <div class="footer-socials">
                <ul class="socials-list">
                    <li>
                        <a href="https://twitter.com/domenicquirl">
                            <span class="icon icon--github"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                                    height="16" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">
                                    <path
                                        d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" />
                                </svg></span>
                            <span>Twitter</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://hachyderm.io/@domenicquirl">
                            <span class="icon icon--github"><svg style="color: white" xmlns="http://www.w3.org/2000/svg"
                                    width="16" height="16" fill="currentColor" class="bi bi-mastodon"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"
                                        fill="white"></path>
                                </svg></span>
                            <span>Mastodon</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        </div>
    </footer>

</body>

</html>